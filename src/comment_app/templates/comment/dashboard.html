{% extends 'base.html' %}

{% load load_comments %}

{% load_comments request.build_absolute_uri %}	

{% block content %}
	
	{{ request.build_absolute_uri }}

	<div class="load_comments" data-url="{{ request.build_absolute_uri }}"></div>
	
	<script>

		$(document).ready(function(){


			// using jQuery
			function getCookie(name) {
			    var cookieValue = null;
			    if (document.cookie && document.cookie !== '') {
			        var cookies = document.cookie.split(';');
			        for (var i = 0; i < cookies.length; i++) {
			            var cookie = jQuery.trim(cookies[i]);
			            // Does this cookie string begin with the name we want?
			            if (cookie.substring(0, name.length + 1) === (name + '=')) {
			                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
			                break;
			            }
			        }
			    }
			    return cookieValue;
			}
			var csrftoken = getCookie('csrftoken');


			function csrfSafeMethod(method) {
			    // these HTTP methods do not require CSRF protection
			    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
			}
			$.ajaxSetup({
			    beforeSend: function(xhr, settings) {
			        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
			            xhr.setRequestHeader("X-CSRFToken", csrftoken);
			        }
			    }
			});



			var endpoint = "http://localhost:9000/api/comments/"
			var requestUrl = $('.load_comments').attr("data-url");
			Materialize.updateTextFields();

			function get_comments(requestUrl){
				$.ajax({
					method:"GET",
					dataType: "json",
					url: endpoint,
					data:{
						url:requestUrl
					},
					success:function(data){
						// console.log(data);
						if (data.length>0){
							$.each(data, function(index, object){
								$(".load_comments").append("<li>"+object.content+"</li>")
							});
						}
						var CommentForm = generateForm();
						$('.load_comments').after(CommentForm);

					},
					error:function(data){
						console.log("error");
					}	
				});
			}

			function generateForm(){
				var html_ = "<form method='POST' class='comment-form materialize-textarea'><textarea name='content'></textarea><input type='submit' value='Comment'></form>"
				return html_
			}

			$(document).on('submit', ".comment-form", function(e){
				e.preventDefault();
				var formData = $(this).serialize();
				alert(formData);
				handleForm(formData);
			});

			function handleForm(formData){
					$.ajax({
						url:endpoint+"create/",
						method:"post",
						data:formData,
						success:function(data){
							get_comments(requestUrl);
						},
						error:function(data){
							console.log("error");
						}
					});
			}

			get_comments(requestUrl);
		});

	</script>

{% endblock %}